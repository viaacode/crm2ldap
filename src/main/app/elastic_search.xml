<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw" xmlns:metadata="http://www.mulesoft.org/schema/mule/metadata" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd">
    <http:request-config name="elastic_search" host="${elastic.host}" port="${elastic.port}" basePath="${elastic.path}" doc:name="HTTP Request Configuration"/>
    <sub-flow name="log_elastic_search">
        <set-payload value="#['']" doc:name="Set Payload - make empty" />
        <dw:transform-message doc:name="Create message" metadata:id="35042ede-c8b2-4c39-9a9e-9f06b8415ded">
            <dw:input-payload/>
            <dw:set-payload><![CDATA[%dw 1.0
%output application/json
--- 
{
	state: flowVars.state,
	timestamp:  now as :datetime {format: "yyyy-MM-dd'T'HH:mm:ss.SSSZ"},
	(event_type: flowVars.event_type) when flowVars.event_type != null,
	(object_type: flowVars.object_type) when flowVars.object_type != null,
	(object_id: flowVars.object_id) when flowVars.object_id != null,
	(company: flowVars.company) when flowVars.company != null,
	(custom_fields: flowVars.custom_fields) when flowVars.custom_fields != null,
	(ldap_sector: flowVars.ldap_sector) when flowVars.ldap_sector != null,
	(category_viaa: flowVars.category_viaa) when flowVars.category_viaa != null,
	(category_content_partner: flowVars.category_content_partner) when flowVars.category_content_partner != null,
	(category_digitaliseringpartner: flowVars.category_digitaliseringpartner) when flowVars.category_digitaliseringpartner != null,
	(category_customer: flowVars.category_customer) when flowVars.category_customer != null,
	(check_sector: flowVars.check_sector) when flowVars.check_sector != null,
	(check_category: flowVars.check_category) when flowVars.check_category != null,
	(category_content_partner: flowVars.category_content_partner) when flowVars.category_content_partner != null,
	(checks_passed: flowVars.checks_passed) when flowVars.checks_passed != null,
	(ldap_business_category: flowVars.ldap_business_category) when flowVars.ldap_business_category != null,
	(or_number: flowVars.or_number) when flowVars.or_number != null,
	(check_category: flowVars.check_category) when flowVars.check_category != null,
	(update_or_number_in_teamleader: flowVars.update_or_number_in_teamleader) when flowVars.update_or_number_in_teamleader != null,
	(company_excists: flowVars.company_excists) when flowVars.company_excists != null,
	(xref_sectors: flowVars.xref_sectors) when flowVars.xref_sectors != null,
	(ldap_dn: flowVars.ldap_dn) when flowVars.ldap_dn != null,
	(error_message: flowVars.error_message) when flowVars.error_message != null,
	(error_cause: flowVars.error_cause) when flowVars.error_cause != null,
	(ldap_entry_excists: flowVars.ldap_entry_excists) when flowVars.ldap_entry_excists != null,
	(ldap_entry_string: flowVars.ldap_entry_string) when flowVars.ldap_entry_string != null
}]]></dw:set-payload>
        </dw:transform-message>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <logger message="#[payload]" level="INFO" doc:name="Debug message"/>
        <http:request config-ref="elastic_search" path="crm2ldap/events" method="POST" doc:name="POST event to ES"/>
    </sub-flow>
</mule>
